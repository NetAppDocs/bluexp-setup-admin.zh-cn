---
sidebar: sidebar 
permalink: task-set-up-permissions-azure.html 
keywords: azure permissions, set up permissions, setup permissions, permissions, custom role, azure custom role, service principal, azure ad service principal, json 
summary: 设置Azure权限、以便您可以使用BlueXP在Azure中管理数据和存储基础架构。如何设置权限取决于您计划使用的安装选项。 
---
= 设置Azure权限
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
在Azure中设置权限、以便您可以使用管理数据和存储基础架构所需的权限部署Connector。如何设置权限取决于您计划使用的安装选项。

您可以从以下安装选项中进行选择：

* *从BlueXp安装*：设置权限、使BlueXP能够通过Azure进行身份验证并部署虚拟机。在部署期间、BlueXP会自动为Connector VM设置权限。
+
<<设置从BlueXP创建Connector的权限,查看分步说明>>。

* *从Azure Marketplace安装*：设置Azure自定义角色以与Connector VM或Azure AD服务主体关联。
+
<<设置在部署Azure Marketplace或手动安装后分配的权限,查看分步说明>>。

* *手动安装*：设置要与Connector VM或Azure AD服务主体关联的Azure自定义角色。
+
<<设置在部署Azure Marketplace或手动安装后分配的权限,查看分步说明>>。





== 设置从BlueXP创建Connector的权限

要从BlueXP创建Connector、您需要为BlueXP提供一个登录名、该登录名必须具有在Azure中创建Connector VM所需的权限。您有两种选择：

. 出现提示时，使用 Microsoft 帐户登录。此帐户必须具有特定的 Azure 权限。这是默认选项。
. 提供有关 Azure AD 服务主体的详细信息。此服务主体还需要特定权限。


使用这两个选项、第一步是创建自定义角色。



=== 创建自定义角色

创建可分配给Azure帐户或服务主体的自定义角色。

.步骤
. 在Azure中复制新自定义角色所需的权限、并将其保存在JSON文件中。
+

NOTE: 此策略仅包含从BlueXP在Azure中启动Connector VM所需的权限。请勿在其他情况下使用此策略。当BlueXP创建Connector时、它会将一组新的权限应用于Connector VM、从而使Connector能够管理公有 云环境中的资源。

+
[source, json]
----
{
    "Name": "Azure SetupAsService",
    "Actions": [
        "Microsoft.Compute/disks/delete",
        "Microsoft.Compute/disks/read",
        "Microsoft.Compute/disks/write",
        "Microsoft.Compute/locations/operations/read",
        "Microsoft.Compute/operations/read",
        "Microsoft.Compute/virtualMachines/instanceView/read",
        "Microsoft.Compute/virtualMachines/read",
        "Microsoft.Compute/virtualMachines/write",
        "Microsoft.Compute/virtualMachines/delete",
        "Microsoft.Compute/virtualMachines/extensions/write",
        "Microsoft.Compute/virtualMachines/extensions/read",
        "Microsoft.Compute/availabilitySets/read",
        "Microsoft.Network/locations/operationResults/read",
        "Microsoft.Network/locations/operations/read",
        "Microsoft.Network/networkInterfaces/join/action",
        "Microsoft.Network/networkInterfaces/read",
        "Microsoft.Network/networkInterfaces/write",
        "Microsoft.Network/networkInterfaces/delete",
        "Microsoft.Network/networkSecurityGroups/join/action",
        "Microsoft.Network/networkSecurityGroups/read",
        "Microsoft.Network/networkSecurityGroups/write",
        "Microsoft.Network/virtualNetworks/checkIpAddressAvailability/read",
        "Microsoft.Network/virtualNetworks/read",
        "Microsoft.Network/virtualNetworks/subnets/join/action",
        "Microsoft.Network/virtualNetworks/subnets/read",
        "Microsoft.Network/virtualNetworks/subnets/virtualMachines/read",
        "Microsoft.Network/virtualNetworks/virtualMachines/read",
        "Microsoft.Network/publicIPAddresses/write",
        "Microsoft.Network/publicIPAddresses/read",
        "Microsoft.Network/publicIPAddresses/delete",
        "Microsoft.Network/networkSecurityGroups/securityRules/read",
        "Microsoft.Network/networkSecurityGroups/securityRules/write",
        "Microsoft.Network/networkSecurityGroups/securityRules/delete",
        "Microsoft.Network/publicIPAddresses/join/action",
        "Microsoft.Network/locations/virtualNetworkAvailableEndpointServices/read",
        "Microsoft.Network/networkInterfaces/ipConfigurations/read",
        "Microsoft.Resources/deployments/operations/read",
        "Microsoft.Resources/deployments/read",
        "Microsoft.Resources/deployments/delete",
        "Microsoft.Resources/deployments/cancel/action",
        "Microsoft.Resources/deployments/validate/action",
        "Microsoft.Resources/resources/read",
        "Microsoft.Resources/subscriptions/operationresults/read",
        "Microsoft.Resources/subscriptions/resourceGroups/delete",
        "Microsoft.Resources/subscriptions/resourceGroups/read",
        "Microsoft.Resources/subscriptions/resourcegroups/resources/read",
        "Microsoft.Resources/subscriptions/resourceGroups/write",
        "Microsoft.Authorization/roleDefinitions/write",
        "Microsoft.Authorization/roleAssignments/write",
        "Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/read",
        "Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/write",
        "Microsoft.Network/networkSecurityGroups/delete",
        "Microsoft.Storage/storageAccounts/delete",
        "Microsoft.Storage/storageAccounts/write",
        "Microsoft.Resources/deployments/write",
        "Microsoft.Resources/deployments/operationStatuses/read",
        "Microsoft.Authorization/roleAssignments/read"
    ],
    "NotActions": [],
    "AssignableScopes": [],
    "Description": "Azure SetupAsService",
    "IsCustom": "true"
}
----
. 通过将Azure订阅ID添加到可分配范围来修改JSON。
+
* 示例 *

+
[source, json]
----
"AssignableScopes": [
"/subscriptions/d333af45-0d07-4154-943d-c25fbzzzzzzz"
],
----
. 使用 JSON 文件在 Azure 中创建自定义角色。
+
以下步骤介绍如何在 Azure Cloud Shell 中使用 Bash 创建角色。

+
.. start https://docs.microsoft.com/en-us/azure/cloud-shell/overview["Azure Cloud Shell"^] 并选择 Bash 环境。
.. 上传 JSON 文件。
+
image:screenshot_azure_shell_upload.png["Azure Cloud Shell 的屏幕截图，您可以在其中选择上传文件的选项。"]

.. 输入以下 Azure 命令行界面命令：
+
[source, azurecli]
----
az role definition create --role-definition Policy_for_Setup_As_Service_Azure.json
----


+
现在，您应具有一个名为 _Azure SetupAsService_ 的自定义角色。现在、您可以将此自定义角色应用于您的用户帐户或服务主体。





=== 设置身份验证方法

要部署BlueXP Connector、BlueXP需要向Azure进行身份验证。您可以选择两种Azure身份验证方法。

[role="tabbed-block"]
====
.Azure用户帐户
--
将自定义角色分配给要从BlueXP部署Connector的用户。

.步骤
. 在Azure门户中、打开*订阅*服务并选择用户的订阅。
. 单击 * 访问控制（ IAM ） * 。
. 单击 * 添加 * > * 添加角色分配 * ，然后添加权限：
+
.. 选择 * Azure SetupAsService* 角色，然后单击 * 下一步 * 。
+

NOTE: Azure SetupAsService是Azure的Connector部署策略中提供的默认名称。如果您为角色选择了其他名称，请选择该名称。

.. 保持选中 * 用户，组或服务主体 * 。
.. 单击 * 选择成员 * ，选择您的用户帐户，然后单击 * 选择 * 。
.. 单击 * 下一步 * 。
.. 单击 * 审核 + 分配 * 。




.结果
Azure用户现在具有从BlueXP部署Connector所需的权限。

--
.服务主体
--
您可以为BlueXP提供具有所需权限的Azure服务主体的凭据、而不是使用Azure帐户登录。

在Azure Active Directory中创建和设置服务主体、并获取BlueXP所需的Azure凭据。

.创建Azure Active Directory应用程序以进行基于角色的访问控制
. 确保您在Azure中拥有创建Active Directory应用程序和将应用程序分配给角色的权限。
+
有关详细信息，请参见 https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions/["Microsoft Azure 文档：所需权限"^]

. 从 Azure 门户中，打开 * Azure Active Directory* 服务。
+
image:screenshot_azure_ad.gif["显示了 Microsoft Azure 中的 Active Directory 服务。"]

. 在菜单中，单击 * 应用程序注册 * 。
. 单击 * 新建注册 * 。
. 指定有关应用程序的详细信息：
+
** * 名称 * ：输入应用程序的名称。
** *帐户类型*：选择帐户类型(任何将适用于BlueXP)。
** * 重定向 URI* ：可以将此字段留空。


. 单击 * 注册 * 。
+
您已创建 AD 应用程序和服务主体。



.为应用程序分配自定义角色
. 从 Azure 门户中，打开 * 订阅 * 服务。
. 选择订阅。
. 单击 * 访问控制（ IAM ） > 添加 > 添加角色分配 * 。
. 在*角色*选项卡中、选择* BlueXP操作员*角色、然后单击*下一步*。
. 在 * 成员 * 选项卡中，完成以下步骤：
+
.. 保持选中 * 用户，组或服务主体 * 。
.. 单击 * 选择成员 * 。
+
image:screenshot-azure-service-principal-role.png["Azure 门户的屏幕截图，显示向应用程序添加角色时的成员选项卡。"]

.. 搜索应用程序的名称。
+
以下是一个示例：

+
image:screenshot_azure_service_principal_role.png["Azure 门户的屏幕截图，其中显示了 Azure 门户中的添加角色分配表。"]

.. 选择应用程序并单击 * 选择 * 。
.. 单击 * 下一步 * 。


. 单击 * 审核 + 分配 * 。
+
现在，服务主体具有部署 Connector 所需的 Azure 权限。

+
如果要管理多个Azure订阅中的资源、则必须将服务主体绑定到其中每个订阅。例如、通过BlueXP、您可以选择要在部署Cloud Volumes ONTAP时使用的订阅。



.添加 Windows Azure 服务管理 API 权限
. 在 * Azure Active Directory* 服务中，单击 * 应用程序注册 * 并选择应用程序。
. 单击 * API 权限 > 添加权限 * 。
. 在 * Microsoft APIs* 下，选择 * Azure Service Management* 。
+
image:screenshot_azure_service_mgmt_apis.gif["Azure 门户的屏幕截图，其中显示了 Azure 服务管理 API 权限。"]

. 单击 * 以组织用户身份访问 Azure 服务管理 * ，然后单击 * 添加权限 * 。
+
image:screenshot_azure_service_mgmt_apis_add.gif["Azure 门户的屏幕截图，显示如何添加 Azure 服务管理 API 。"]



.获取应用程序的应用程序ID和目录ID
. 在 * Azure Active Directory* 服务中，单击 * 应用程序注册 * 并选择应用程序。
. 复制 * 应用程序（客户端） ID* 和 * 目录（租户） ID* 。
+
image:screenshot_azure_app_ids.gif["显示 Azure Active Directory 中某个应用程序的应用程序（客户端） ID 和目录（租户） ID 的屏幕截图。"]

+
将Azure帐户添加到BlueXP时、您需要提供应用程序(客户端) ID和目录(租户) ID。BlueXP使用ID以编程方式登录。



.创建客户端密钥
. 打开 * Azure Active Directory* 服务。
. 单击 * 应用程序注册 * 并选择您的应用程序。
. 单击 * 证书和密码 > 新客户端密钥 * 。
. 提供密钥和持续时间的问题描述。
. 单击 * 添加 * 。
. 复制客户端密钥的值。
+
image:screenshot_azure_client_secret.gif["Azure 门户的屏幕截图，其中显示了 Azure AD 服务主体的客户端密钥。"]

+
您现在拥有一个客户端密钥、BlueXP可以使用它向Azure AD进行身份验证。



.结果
此时，您的服务主体已设置完毕，您应已复制应用程序（客户端） ID ，目录（租户） ID 和客户端密钥值。创建Connector时、您需要在BlueXP中输入此信息。

--
====


== 设置在部署Azure Marketplace或手动安装后分配的权限

如果您从Azure Marketplace部署Connector、或者在您自己的Linux主机上手动安装Connector软件、则可以通过以下方式提供权限：

* 选项1：使用系统分配的托管身份为Azure虚拟机分配自定义角色。
* 选项2：为BlueXP提供具有所需权限的Azure服务主体的凭据。


[role="tabbed-block"]
====
.自定义角色
--
.步骤
. 如果您计划在自己的主机上手动安装软件、请在虚拟机上启用系统分配的托管身份、以便您可以通过自定义角色提供所需的Azure权限。
+
https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm["Microsoft Azure文档：使用Azure门户为虚拟机上的Azure资源配置托管身份"^]

. 复制的内容 link:reference-permissions-azure.html["Connector的自定义角色权限"] 并将其保存在JSON文件中。
. 通过将 Azure 订阅 ID 添加到可分配范围来修改 JSON 文件。
+
您应添加要用于BlueXP的每个Azure订阅的ID。

+
* 示例 *

+
[source, json]
----
"AssignableScopes": [
"/subscriptions/d333af45-0d07-4154-943d-c25fbzzzzzzz",
"/subscriptions/54b91999-b3e6-4599-908e-416e0zzzzzzz",
"/subscriptions/398e471c-3b42-4ae7-9b59-ce5bbzzzzzzz"
----
. 使用 JSON 文件在 Azure 中创建自定义角色。
+
以下步骤介绍如何在 Azure Cloud Shell 中使用 Bash 创建角色。

+
.. start https://docs.microsoft.com/en-us/azure/cloud-shell/overview["Azure Cloud Shell"^] 并选择 Bash 环境。
.. 上传 JSON 文件。
+
image:screenshot_azure_shell_upload.png["Azure Cloud Shell 的屏幕截图，您可以在其中选择上传文件的选项。"]

.. 使用Azure命令行界面创建自定义角色：
+
[source, azurecli]
----
az role definition create --role-definition Connector_Policy.json
----




.结果
现在、您应该拥有一个名为BlueXP操作员的自定义角色、可以将该角色分配给Connector虚拟机。

link:task-provide-permissions-azure.html["了解如何为BlueXP提供这些权限"]。

--
.服务主体
--
在Azure Active Directory中创建和设置服务主体、并获取BlueXP所需的Azure凭据。

.创建Azure Active Directory应用程序以进行基于角色的访问控制
. 确保您在Azure中拥有创建Active Directory应用程序和将应用程序分配给角色的权限。
+
有关详细信息，请参见 https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions/["Microsoft Azure 文档：所需权限"^]

. 从 Azure 门户中，打开 * Azure Active Directory* 服务。
+
image:screenshot_azure_ad.gif["显示了 Microsoft Azure 中的 Active Directory 服务。"]

. 在菜单中，单击 * 应用程序注册 * 。
. 单击 * 新建注册 * 。
. 指定有关应用程序的详细信息：
+
** * 名称 * ：输入应用程序的名称。
** *帐户类型*：选择帐户类型(任何将适用于BlueXP)。
** * 重定向 URI* ：可以将此字段留空。


. 单击 * 注册 * 。
+
您已创建 AD 应用程序和服务主体。



.将应用程序分配给角色
. 创建自定义角色：
+
.. 复制的内容 link:reference-permissions-azure.html["Connector的自定义角色权限"] 并将其保存在JSON文件中。
.. 通过将 Azure 订阅 ID 添加到可分配范围来修改 JSON 文件。
+
您应该为每个 Azure 订阅添加 ID 、用户将从中创建 Cloud Volumes ONTAP 系统。

+
* 示例 *

+
[source, json]
----
"AssignableScopes": [
"/subscriptions/d333af45-0d07-4154-943d-c25fbzzzzzzz",
"/subscriptions/54b91999-b3e6-4599-908e-416e0zzzzzzz",
"/subscriptions/398e471c-3b42-4ae7-9b59-ce5bbzzzzzzz"
----
.. 使用 JSON 文件在 Azure 中创建自定义角色。
+
以下步骤介绍如何在 Azure Cloud Shell 中使用 Bash 创建角色。

+
*** start https://docs.microsoft.com/en-us/azure/cloud-shell/overview["Azure Cloud Shell"^] 并选择 Bash 环境。
*** 上传 JSON 文件。
+
image:screenshot_azure_shell_upload.png["Azure Cloud Shell 的屏幕截图，您可以在其中选择上传文件的选项。"]

*** 使用Azure命令行界面创建自定义角色：
+
[source, azurecli]
----
az role definition create --role-definition Connector_Policy.json
----
+
现在、您应该拥有一个名为BlueXP操作员的自定义角色、可以将该角色分配给Connector虚拟机。





. 将应用程序分配给角色：
+
.. 从 Azure 门户中，打开 * 订阅 * 服务。
.. 选择订阅。
.. 单击 * 访问控制（ IAM ） > 添加 > 添加角色分配 * 。
.. 在*角色*选项卡中、选择* BlueXP操作员*角色、然后单击*下一步*。
.. 在 * 成员 * 选项卡中，完成以下步骤：
+
*** 保持选中 * 用户，组或服务主体 * 。
*** 单击 * 选择成员 * 。
+
image:screenshot-azure-service-principal-role.png["Azure 门户的屏幕截图，显示向应用程序添加角色时的成员选项卡。"]

*** 搜索应用程序的名称。
+
以下是一个示例：

+
image:screenshot_azure_service_principal_role.png["Azure 门户的屏幕截图，其中显示了 Azure 门户中的添加角色分配表。"]

*** 选择应用程序并单击 * 选择 * 。
*** 单击 * 下一步 * 。


.. 单击 * 审核 + 分配 * 。
+
现在，服务主体具有部署 Connector 所需的 Azure 权限。

+
如果要从多个 Azure 订阅部署 Cloud Volumes ONTAP ，则必须将服务主体绑定到每个订阅。通过BlueXP、您可以选择要在部署Cloud Volumes ONTAP 时使用的订阅。





.添加 Windows Azure 服务管理 API 权限
. 在 * Azure Active Directory* 服务中，单击 * 应用程序注册 * 并选择应用程序。
. 单击 * API 权限 > 添加权限 * 。
. 在 * Microsoft APIs* 下，选择 * Azure Service Management* 。
+
image:screenshot_azure_service_mgmt_apis.gif["Azure 门户的屏幕截图，其中显示了 Azure 服务管理 API 权限。"]

. 单击 * 以组织用户身份访问 Azure 服务管理 * ，然后单击 * 添加权限 * 。
+
image:screenshot_azure_service_mgmt_apis_add.gif["Azure 门户的屏幕截图，显示如何添加 Azure 服务管理 API 。"]



.获取应用程序的应用程序ID和目录ID
. 在 * Azure Active Directory* 服务中，单击 * 应用程序注册 * 并选择应用程序。
. 复制 * 应用程序（客户端） ID* 和 * 目录（租户） ID* 。
+
image:screenshot_azure_app_ids.gif["显示 Azure Active Directory 中某个应用程序的应用程序（客户端） ID 和目录（租户） ID 的屏幕截图。"]

+
将Azure帐户添加到BlueXP时、您需要提供应用程序(客户端) ID和目录(租户) ID。BlueXP使用ID以编程方式登录。



.创建客户端密钥
. 打开 * Azure Active Directory* 服务。
. 单击 * 应用程序注册 * 并选择您的应用程序。
. 单击 * 证书和密码 > 新客户端密钥 * 。
. 提供密钥和持续时间的问题描述。
. 单击 * 添加 * 。
. 复制客户端密钥的值。
+
image:screenshot_azure_client_secret.gif["Azure 门户的屏幕截图，其中显示了 Azure AD 服务主体的客户端密钥。"]

+
您现在拥有一个客户端密钥、BlueXP可以使用它向Azure AD进行身份验证。



.结果
此时，您的服务主体已设置完毕，您应已复制应用程序（客户端） ID ，目录（租户） ID 和客户端密钥值。添加Azure帐户时、您需要在BlueXP中输入此信息。

link:task-provide-permissions-azure.html["了解如何为BlueXP提供这些权限"]。

--
====
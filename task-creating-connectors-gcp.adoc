---
sidebar: sidebar 
permalink: task-creating-connectors-gcp.html 
keywords: create connector in gcp, launch connector in gcp, deploy connector in gcp, gcp connector, connector gcp, connector permissions 
summary: 在使用大多数BlueXP功能之前、BlueXP帐户管理员需要先部署Connector。借助此连接器、BlueXP可以管理公有 云环境中的资源和流程。 
---
= 从BlueXP在Google Cloud中创建连接器
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
BlueXP帐户管理员需要先部署_Connector_、然后才能使用大多数BlueXP功能。 link:concept-connectors.html["了解何时需要连接器"]。借助此连接器、BlueXP可以管理公有 云环境中的资源和流程。

此页面介绍如何直接从BlueXP在Google Cloud中创建Connector。 link:concept-connectors.html#how-to-create-a-connector["了解部署 Connector 的其他方法"]。

这些步骤必须由具有帐户管理员角色的用户完成。Workspace 管理员无法创建 Connector 。


TIP: 在创建首个Cloud Volumes ONTAP 工作环境时、如果您还没有连接器、BlueXP将提示您创建一个连接器。



== 快速入门

按照以下步骤快速入门，或者向下滚动到其余部分以了解完整详细信息。

.跨度 class="image><img src="https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png"[] Alt-one"></span>设置权限
* 通过创建并附加自定义角色、确保您的Google Cloud帐户具有正确的权限。
+
 up permissions to deploy the Connector。

* 创建Connector VM时、您需要将其与服务帐户关联。此服务帐户必须具有一个自定义角色、该角色有权管理Google Cloud中的资源。
+
 up a service account for the Connector。

* 如果您使用的是共享VPC、请在服务项目和主机项目中设置权限。
+
 up shared VPC permissions。



[role="quick-margin-para"]
您需要一个VPC和子网、并可通过出站Internet访问特定端点。如果出站Internet需要HTTP代理、则需要IP地址、凭据和HTTPS证书。

[role="quick-margin-para"]
 up networking,查看网络连接要求。

.跨度 class="image><img src="https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png"[] Alt-Three "></span>启用Google Cloud API
* Cloud Deployment Manager V2 API
* 云日志记录 API
* Cloud Resource Manager API
* 计算引擎 API
* 身份和访问管理（ IAM ） API


[role="quick-margin-para"]
单击Connector下拉列表、选择*添加连接器*、然后按照提示进行操作。

[role="quick-margin-para"]
 a Connector,按照分步说明进行操作。



== 设置权限

以下项需要权限：

* 要部署Connector VM的用户
* 在部署期间需要附加到Connector VM的服务帐户
* 共享VPC权限(如果您使用共享VPC将资源部署到服务项目中)




=== 设置部署Connector的权限

在部署Connector之前、您需要确保Google Cloud帐户具有正确的权限。

.步骤
. https://cloud.google.com/iam/docs/creating-custom-roles#iam-custom-roles-create-gcloud["创建自定义角色"^] 其中包括以下权限：
+
[source, yaml]
----
title: Connector deployment policy
description: Permissions for the user who deploys the Connector from BlueXP
stage: GA
includedPermissions:
- compute.disks.create
- compute.disks.get
- compute.disks.list
- compute.disks.setLabels
- compute.disks.use
- compute.firewalls.create
- compute.firewalls.delete
- compute.firewalls.get
- compute.firewalls.list
- compute.globalOperations.get
- compute.images.get
- compute.images.getFromFamily
- compute.images.list
- compute.images.useReadOnly
- compute.instances.attachDisk
- compute.instances.create
- compute.instances.get
- compute.instances.list
- compute.instances.setDeletionProtection
- compute.instances.setLabels
- compute.instances.setMachineType
- compute.instances.setMetadata
- compute.instances.setTags
- compute.instances.start
- compute.instances.updateDisplayDevice
- compute.machineTypes.get
- compute.networks.get
- compute.networks.list
- compute.networks.updatePolicy
- compute.projects.get
- compute.regions.get
- compute.regions.list
- compute.subnetworks.get
- compute.subnetworks.list
- compute.zoneOperations.get
- compute.zones.get
- compute.zones.list
- deploymentmanager.compositeTypes.get
- deploymentmanager.compositeTypes.list
- deploymentmanager.deployments.create
- deploymentmanager.deployments.delete
- deploymentmanager.deployments.get
- deploymentmanager.deployments.list
- deploymentmanager.manifests.get
- deploymentmanager.manifests.list
- deploymentmanager.operations.get
- deploymentmanager.operations.list
- deploymentmanager.resources.get
- deploymentmanager.resources.list
- deploymentmanager.typeProviders.get
- deploymentmanager.typeProviders.list
- deploymentmanager.types.get
- deploymentmanager.types.list
- resourcemanager.projects.get
- compute.instances.setServiceAccount
- iam.serviceAccounts.list
----
. 将自定义角色附加到要从BlueXP部署Connector的用户。


Google Cloud用户现在具有创建Connector所需的权限。



=== 为Connector设置服务帐户

需要使用服务帐户为Connector提供在Google Cloud中管理资源所需的权限。创建此服务帐户时，您需要将其与 Connector VM 关联。

此服务帐户的权限与您在上一节中设置的权限不同。

.步骤
. https://cloud.google.com/iam/docs/creating-custom-roles#iam-custom-roles-create-gcloud["创建自定义角色"^] 其中包括以下权限：
+
[source, yaml]
----
title: NetApp BlueXP
description: Permissions for the service account associated with the Connector instance.
stage: GA
includedPermissions:
- iam.serviceAccounts.actAs
- compute.regionBackendServices.create
- compute.regionBackendServices.get
- compute.regionBackendServices.list
- compute.networks.updatePolicy
- compute.backendServices.create
- compute.addresses.list
- compute.disks.create
- compute.disks.createSnapshot
- compute.disks.delete
- compute.disks.get
- compute.disks.list
- compute.disks.setLabels
- compute.disks.use
- compute.firewalls.create
- compute.firewalls.delete
- compute.firewalls.get
- compute.firewalls.list
- compute.globalOperations.get
- compute.images.get
- compute.images.getFromFamily
- compute.images.list
- compute.images.useReadOnly
- compute.instances.addAccessConfig
- compute.instances.attachDisk
- compute.instances.create
- compute.instances.delete
- compute.instances.detachDisk
- compute.instances.get
- compute.instances.getSerialPortOutput
- compute.instances.list
- compute.instances.setDeletionProtection
- compute.instances.setLabels
- compute.instances.setMachineType
- compute.instances.setMetadata
- compute.instances.setTags
- compute.instances.start
- compute.instances.stop
- compute.instances.updateDisplayDevice
- compute.machineTypes.get
- compute.networks.get
- compute.networks.list
- compute.projects.get
- compute.regions.get
- compute.regions.list
- compute.snapshots.create
- compute.snapshots.delete
- compute.snapshots.get
- compute.snapshots.list
- compute.snapshots.setLabels
- compute.subnetworks.get
- compute.subnetworks.list
- compute.subnetworks.use
- compute.subnetworks.useExternalIp
- compute.zoneOperations.get
- compute.zones.get
- compute.zones.list
- compute.instances.setServiceAccount
- deploymentmanager.compositeTypes.get
- deploymentmanager.compositeTypes.list
- deploymentmanager.deployments.create
- deploymentmanager.deployments.delete
- deploymentmanager.deployments.get
- deploymentmanager.deployments.list
- deploymentmanager.manifests.get
- deploymentmanager.manifests.list
- deploymentmanager.operations.get
- deploymentmanager.operations.list
- deploymentmanager.resources.get
- deploymentmanager.resources.list
- deploymentmanager.typeProviders.get
- deploymentmanager.typeProviders.list
- deploymentmanager.types.get
- deploymentmanager.types.list
- logging.logEntries.list
- logging.privateLogEntries.list
- resourcemanager.projects.get
- storage.buckets.create
- storage.buckets.delete
- storage.buckets.get
- storage.buckets.list
- cloudkms.cryptoKeyVersions.useToEncrypt
- cloudkms.cryptoKeys.get
- cloudkms.cryptoKeys.list
- cloudkms.keyRings.list
- storage.buckets.update
- iam.serviceAccounts.getIamPolicy
- iam.serviceAccounts.list
- storage.objects.get
- storage.objects.list
- monitoring.timeSeries.list
- storage.buckets.getIamPolicy
----
. https://cloud.google.com/iam/docs/creating-managing-service-accounts#creating_a_service_account["创建Google Cloud服务帐户并应用您刚刚创建的自定义角色"^]。
. 如果要在其他项目中部署 Cloud Volumes ONTAP ， https://cloud.google.com/iam/docs/granting-changing-revoking-access#granting-console["通过向该项目添加具有BlueXP角色的服务帐户来授予访问权限"^]。您需要对每个项目重复此步骤。


已设置Connector VM的服务帐户。



=== 设置共享VPC权限

如果您使用共享 VPC 将资源部署到服务项目中，则需要以下权限。此表仅供参考，您的环境应在 IAM 配置完成后反映权限表。

[cols="10,10,10,20,20,30"]
|===
| 身份 | 创建者 | 托管在中 | 服务项目权限 | 托管项目权限 | 目的 


| 用于部署Connector的Google帐户 | 自定义 | 服务项目  a| 
* link:task-creating-connectors-gcp.html#set-up-permissions-to-deploy-the-connector["以上部分中的权限"]

 a| 
* compute.networkUser

| 在服务项目中部署Connector 


| 连接器服务帐户 | 自定义 | 服务项目  a| 
* link:task-creating-connectors-gcp.html#set-up-a-service-account-for-the-connector["以上部分中的权限"]

 a| 
* compute.networkUser
* deploymentmanager.editor

| 在服务项目中部署和维护 Cloud Volumes ONTAP 和服务 


| Cloud Volumes ONTAP 服务帐户 | 自定义 | 服务项目  a| 
* storage.admin
* 成员：BlueXP服务帐户serviceAccount.user

| 不适用 | （可选）适用于数据分层和 Cloud Backup 


| Google API 服务代理 | Google Cloud | 服务项目  a| 
* （默认）编辑器

 a| 
* compute.networkUser

| 代表部署与Google Cloud API进行交互。允许BlueXP使用共享网络。 


| Google Compute Engine 默认服务帐户 | Google Cloud | 服务项目  a| 
* （默认）编辑器

 a| 
* compute.networkUser

| 代表部署部署部署部署Google Cloud实例和计算基础架构。允许BlueXP使用共享网络。 
|===
注释：

. 只有在未向部署传递防火墙规则并选择让BlueXP为您创建这些规则的情况下、主机项目才需要使用deploymentmanager.editor.如果未指定任何规则、BlueXP将在包含VPC0防火墙规则的主机项目中创建部署。
. 只有当您不向部署传递防火墙规则并选择让BlueXP为您创建这些规则时、才需要firewall.create和firewall.delete。这些权限位于BlueXP帐户.YAML文件中。如果要使用共享 VPC 部署 HA 对，则会使用这些权限为 VC1 ， 2 和 3 创建防火墙规则。对于所有其他部署，这些权限还将用于为 VPC0 创建规则。
. 对于数据分层，分层服务帐户必须在服务帐户上具有 serviceAccount.user 角色，而不仅仅是在项目级别。目前，如果您在项目级别分配 serviceAccount.user ，则在使用 getIAMPolicy 查询服务帐户时不会显示权限。




== 设置网络

设置您的网络，以便 Connector 可以管理公有云环境中的资源和流程。除了为Connector提供VPC和子网之外、您还需要确保满足以下要求。



=== 连接到目标网络

连接器要求与您要创建的工作环境类型以及计划启用的服务建立网络连接。

例如、如果您在公司网络中安装了连接器、则必须设置与启动Cloud Volumes ONTAP 的VPC的VPN连接。



=== 出站 Internet 访问

连接器需要通过出站 Internet 访问来管理公有云环境中的资源和流程。

[cols="2*"]
|===
| 端点 | 目的 


| https://support.netapp.com | 获取许可信息并向 NetApp 支持部门发送 AutoSupport 消息。 


 a| 
https://*.api.bluexp.netapp.com

https://api.bluexp.netapp.com

https://*.cloudmanager.cloud.netapp.com

https://cloudmanager.cloud.netapp.com
 a| 
在BlueXP中提供SaaS功能和服务。


NOTE: Connector当前正在联系cloudmanager.cloud.netapp.com"、但在即将发布的版本中、它将开始联系api.bluexp.netapp.com"。



| https://cloudmanagerinfraprod.azurecr.io \https://*.blob.core.windows.net | 升级 Connector 及其 Docker 组件。 
|===


=== 代理服务器

如果您的组织要求为所有传出Internet流量部署HTTP代理、请获取有关HTTP代理的以下信息：

* IP 地址
* 凭据
* HTTPS证书




=== 安全组

没有传入到连接器的流量、除非您启动该流量、或者该连接器用作AutoSupport 消息的代理。HTTP 和 HTTPS 可用于访问 link:concept-connectors.html#the-local-user-interface["本地 UI"]，在极少数情况下使用。只有在需要连接到主机进行故障排除时，才需要使用 SSH 。



=== IP地址限制

可能与172范围内的IP地址冲突。 link:reference-limitations.html["了解有关此限制的更多信息"]。



== 启用 Google Cloud API

部署连接器和 Cloud Volumes ONTAP 需要多个 API 。

.步骤
. https://cloud.google.com/apis/docs/getting-started#enabling_apis["在项目中启用以下 Google Cloud API"^]。
+
** Cloud Deployment Manager V2 API
** 云日志记录 API
** Cloud Resource Manager API
** 计算引擎 API
** 身份和访问管理（ IAM ） API






== 创建连接器

直接从BlueXP用户界面或使用gcloud在Google Cloud中创建Connector。

[role="tabbed-block"]
====
.BlueXP
--
. 如果要创建首个工作环境，请单击 * 添加工作环境 * 并按照提示进行操作。否则，请单击 * 连接器 * 下拉列表并选择 * 添加连接器 * 。
+
image:screenshot_connector_add.gif["标题中显示 Connector 图标和 Add Connector 操作的屏幕截图。"]

. 选择 * Google Cloud Platform* 作为云提供商。
. 在*部署Connector*页面上、查看有关所需内容的详细信息。您有两种选择：
+
.. 单击*继续*以使用产品指南为部署做准备。产品指南中的每个步骤都包含文档本页中包含的信息。
.. 如果您已按照此页面上的步骤做好准备、请单击*跳至部署*。


. 按照向导中的步骤创建 Connector ：
+
** 如果出现提示，请登录到您的 Google 帐户，该帐户应具有创建虚拟机实例所需的权限。
+
此表由 Google 拥有和托管。您的凭据不会提供给 NetApp 。

** *详细信息*：输入虚拟机实例的名称、指定标记、选择项目、然后选择具有所需权限的服务帐户(有关详细信息、请参见上述部分)。
** * 位置 * ：指定实例的区域，分区， VPC 和子网。
** * 网络 * ：选择是否启用公有 IP 地址，并可选择指定代理配置。
** * 防火墙策略 * ：选择是创建新的防火墙策略，还是选择允许入站 HTTP ， HTTPS 和 SSH 访问的现有防火墙策略。
** * 审核 * ：查看您选择的内容，确认您的设置正确无误。


. 单击 * 添加 * 。
+
此实例应在大约 7 分钟后准备就绪。您应停留在页面上，直到此过程完成。



--
.云
--
. 使用您首选的方法登录到 gcloud SDK 。
+
在我们的示例中、我们将使用安装了gcloud SDK的本地Shell、但您可以在Google云控制台中使用原生 Google Cloud Shell。

+
有关 Google Cloud SDK 的详细信息，请访问 link:https://cloud.google.com/sdk["Google Cloud SDK 文档页面"^]。

. 验证您是否以具有上一节中定义的所需权限的用户身份登录：
+
[source, bash]
----
gcloud auth list
----
+
输出应显示以下内容，其中 * 用户帐户是要以身份登录的所需用户帐户：

+
[listing]
----
Credentialed Accounts
ACTIVE  ACCOUNT
     some_user_account@domain.com
*    desired_user_account@domain.com
To set the active account, run:
 $ gcloud config set account `ACCOUNT`
Updates are available for some Cloud SDK components. To install them,
please run:
$ gcloud components update
----
. 运行 `gcloud compute instances create` 命令：
+
[source, bash]
----
gcloud compute instances create <instance-name>
  --machine-type=n2-standard-4
  --image-project=netapp-cloudmanager
  --image-family=cloudmanager
  --scopes=cloud-platform
  --project=<project>
  --service-account=<<service-account>
  --zone=<zone>
  --no-address
  --tags <network-tag>
  --network <network-path>
  --subnet <subnet-path>
  --boot-disk-kms-key <kms-key-path>
----
+
实例名称:: VM 实例所需的实例名称。
项目:: （可选）要部署 VM 的项目。
服务帐户:: 步骤 2 输出中指定的服务帐户。
分区:: 要部署 VM 的区域
无地址:: （可选）不使用外部 IP 地址（您需要云 NAT 或代理将流量路由到公有 Internet ）
网络标记:: （可选）添加网络标记以使用标记将防火墙规则链接到 Connector 实例
网络路径:: （可选）添加要将 Connector 部署到的网络的名称（对于共享 VPC ，您需要完整路径）
子网路径:: （可选）添加要将 Connector 部署到的子网的名称（对于共享 VPC ，您需要完整路径）
kms-key-path:: （可选）添加 KMS 密钥以加密连接器的磁盘（还需要应用 IAM 权限）
+
--
有关这些标志的详细信息，请访问 link:https://cloud.google.com/sdk/gcloud/reference/compute/instances/create["Google Cloud 计算 SDK 文档"^]。

--


+
运行命令可使用 NetApp 黄金映像部署 Connector 。Connector 实例和软件应在大约五分钟内运行。

. 从已连接到 Connector 实例的主机打开 Web 浏览器，然后输入以下 URL ：
+
https://_ipaddress_[]

. 登录后，设置 Connector ：
+
.. 指定要与 Connector 关联的 NetApp 帐户。
+
link:concept-netapp-accounts.html["了解 NetApp 客户"]。

.. 输入系统名称。
+
image:screenshot_set_up_cloud_manager.gif["屏幕截图显示了 \"Set Up Connector\" 屏幕，可用于选择 NetApp 帐户并为系统命名。"]





--
====
现在，您可以使用 NetApp 帐户安装并设置 Connector 。在创建新的工作环境时、BlueXP将自动使用此Connector。但是，如果您有多个 Connector ，则需要 link:task-managing-connectors.html["在它们之间切换"]。

如果您在创建Connector的同一Google Cloud帐户中有Google Cloud Storage存储分段、则会在Canvas上自动显示Google Cloud Storage工作环境。 link:task-viewing-gcp-storage.html["详细了解如何使用此工作环境"]。



== 打开端口3128以显示AutoSupport 消息

如果您计划在出站Internet连接不可用的子网中部署Cloud Volumes ONTAP 系统、则BlueXP会自动将Cloud Volumes ONTAP 配置为使用此连接器作为代理服务器。

唯一的要求是确保Connector的安全组允许通过端口3128进行_inbound_连接。部署Connector后、您需要打开此端口。

如果对Cloud Volumes ONTAP 使用默认安全组、则不需要对其安全组进行任何更改。但是、如果您计划为Cloud Volumes ONTAP 定义严格的出站规则、则还需要确保Cloud Volumes ONTAP 安全组允许通过端口3128进行_outout_连接。

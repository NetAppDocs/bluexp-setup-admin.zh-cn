---
sidebar: sidebar 
permalink: task-install-restricted-mode.html 
keywords: government region, gov, govcloud, connector, sovereign cloud 
summary: 在受限模式下部署Connector、以便使用与BlueXP SaaS层的出站连接有限的BlueXP。要开始使用、请安装Connector、通过访问Connector上运行的用户界面来设置BlueXP、然后提供您先前设置的云权限。 
---
= 在受限模式下部署连接器
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
在受限模式下部署Connector、以便使用与BlueXP SaaS层的出站连接有限的BlueXP。要开始使用、请安装Connector、通过访问Connector上运行的用户界面来设置BlueXP、然后提供您先前设置的云权限。



== 安装连接器

从云提供商的市场或通过在您自己的Linux主机上手动安装此软件来安装Connector。

[role="tabbed-block"]
====
.AWS商业市场
--
.您需要的内容
* 满足网络连接要求的VPC和子网。
+
link:task-prepare-restricted-mode.html["了解网络连接要求"]

* 一个IAM角色、其附加策略包括Connector所需的权限。
+
link:task-prepare-restricted-mode.html#prepare-cloud-permissions["了解如何设置AWS权限"]

* 为IAM用户订阅和取消订阅AWS Marketplace的权限。
* EC2实例的密钥对。


.步骤
. 转至 https://aws.amazon.com/marketplace/pp/B018REK8QG["AWS Marketplace上的BlueXP页面"^]
. 在 Marketplace 页面上，单击 * 继续订阅 * ，然后单击 * 继续配置 * 。
+
image:screenshot-subscribe-aws.png["屏幕截图显示了 AWS Marketplace 上的 Continue to Subscribe and Continue to Configuration 按钮。"]

. 更改任何默认选项，然后单击 * 继续启动 * 。
. 在 * 选择操作 * 下，选择 * 通过 EC2 启动 * ，然后单击 * 启动 * 。
+
以下步骤介绍了如何从EC2控制台启动实例、因为控制台允许您将IAM角色附加到Connector实例。使用 * 从网站启动 * 操作无法实现这一点。

. 按照提示配置和部署实例：
+
** *名称和标记*：输入实例的名称和标记。
** *应用程序和操作系统映像*：跳过此部分。已选择连接器AMI。
** *实例类型*：根据区域可用性、选择支持的实例类型之一(建议使用T3.xlarge)。
+
link:task-prepare-restricted-mode.html["查看实例要求"]。

** *密钥对(login)*：选择要用于安全连接到实例的密钥对。
** *网络设置*：根据需要编辑网络设置：
+
*** 选择所需的VPC和子网。
*** 指定实例是否应具有公有 IP地址。
*** 指定防火墙设置、以便为Connector实例启用所需的连接方法：SSH、HTTP和HTTPS。


** *配置存储*：保留默认存储选项。
** *高级详细信息*：在* IAM实例配置文件*下、选择包含Connector所需权限的IAM角色。
+
link:task-prepare-restricted-mode.html["了解如何设置AWS权限"]。

** *摘要*：查看摘要、然后单击*启动实例*。




.结果
AWS 使用指定的设置启动软件。Connector 实例和软件应在大约五分钟内运行。

.下一步是什么？
设置BlueXP。

--
.AWS Gov Marketplace
--
.您需要的内容
* 满足网络连接要求的VPC和子网。
+
link:task-prepare-restricted-mode.html["了解网络连接要求"]

* 一个IAM角色、其附加策略包括Connector所需的权限。
+
link:task-prepare-restricted-mode.html#prepare-cloud-permissions["了解如何设置AWS权限"]

* 为IAM用户订阅和取消订阅AWS Marketplace的权限。
* EC2实例的密钥对。


.步骤
. 转到AWS Marketplace中的BlueXP产品。
+
.. 打开EC2服务并选择*启动实例*。
.. 选择* AWS Marketplace *。
.. 搜索BlueXP并选择产品。
+
image:screenshot-gov-cloud-mktp.png["在AWS Marketplace中搜索BlueXP产品后显示该产品的屏幕截图"]

.. 单击 * 继续 * 。


. 按照提示配置和部署实例：
+
** *选择一个实例类型*：根据区域可用性、选择一个受支持的实例类型(建议使用T3.xlarge)。
+
link:task-prepare-restricted-mode.html["查看实例要求"]。

** *配置实例详细信息*：选择一个VPC和子网、选择您在第1步中创建的IAM角色、启用终止保护(建议)、然后选择符合您要求的任何其他配置选项。
+
image:screenshot_aws_iam_role.gif["显示 AWS 中配置实例页面上的字段的屏幕截图。此时将选择您应在步骤 1 中创建的 IAM 角色。"]

** * 添加存储 * ：保留默认存储选项。
** * 添加标记 * ：根据需要输入实例的标记。
** * 配置安全组 * ：指定 Connector 实例所需的连接方法： SSH ， HTTP 和 HTTPS 。
** * 审阅 * ：查看您选择的内容，然后单击 * 启动 * 。




.结果
AWS 使用指定的设置启动软件。Connector 实例和软件应在大约五分钟内运行。

.下一步是什么？
设置BlueXP。

--
.Azure Marketplace
--
.您需要的内容
* 满足网络连接要求的vNet和子网。
+
link:task-prepare-restricted-mode.html["了解网络连接要求"]

* 一个Azure自定义角色、其中包含Connector所需的权限。
+
link:task-prepare-restricted-mode.html#prepare-cloud-permissions["了解如何设置Azure权限"]



.步骤
. 转到Azure Marketplace中的NetApp Connector VM页面。
+
** https://azuremarketplace.microsoft.com/en-us/marketplace/apps/netapp.netapp-oncommand-cloud-manager["适用于商业区域的Azure Marketplace页面"^]
** https://portal.azure.us/#create/netapp.netapp-oncommand-cloud-manageroccm-byol["Azure政府区域的Azure Marketplace页面"^]


. 单击 * 立即获取 * ，然后单击 * 继续 * 。
. 在 Azure 门户中，单击 * 创建 * ，然后按照步骤配置虚拟机。
+
配置虚拟机时，请注意以下事项：

+
** *虚拟机大小*：选择满足CPU和RAM要求的虚拟机大小。我们建议使用 DS3 v2 。
** *磁盘*：此连接器可以对HDD或SSD磁盘执行最佳性能。
** *公共IP*：如果要对Connector VM使用公共IP地址、则该IP地址必须使用基本SKU以确保BlueXP使用此公共IP地址。
+
image:screenshot-azure-sku.png["在Azure中创建新IP地址的屏幕截图、可用于在SKU字段的下选择基本。"]

+
如果改用标准SKU IP地址、则BlueXP将使用Connector的_private_ IP地址、而不是公共IP。如果用于访问BlueXP控制台的计算机无法访问该专用IP地址、则BlueXP控制台的操作将失败。

+
https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses#sku["Azure文档：公共IP SKU"^]

** *网络安全组*：Connector需要使用SSH、HTTP和HTTPS进行入站连接。
+
link:task-prepare-restricted-mode.html["了解网络连接要求"]。

** *身份*：在*管理*下、选择*启用系统分配的受管身份*。
+
此设置非常重要，因为托管身份允许 Connector 虚拟机在不提供任何凭据的情况下向 Azure Active Directory 标识自己。 https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview["详细了解 Azure 资源的托管身份"^]。



. 在 * 查看 + 创建 * 页面上，查看所做的选择并单击 * 创建 * 以开始部署。


.结果
Azure 使用指定的设置部署虚拟机。虚拟机和 Connector 软件应在大约五分钟内运行。

.下一步是什么？
设置BlueXP。

--
.手动安装
--
.您需要的内容
* 安装Connector的root权限。
* 有关代理服务器的详细信息、如果从Connector访问Internet需要代理。
+
您可以选择在安装后配置代理服务器、但这样做需要重新启动Connector。

* CA签名证书、如果代理服务器使用HTTPS或代理是截获代理。


.关于此任务
* 此安装将安装 AWS 命令行工具（ awscli ），以便从 NetApp 支持部门执行恢复过程。
+
如果您收到安装 AWSCLI 失败的消息，则可以安全地忽略该消息。如果没有工具，连接器可以成功运行。

* NetApp 支持站点上提供的安装程序可能是早期版本。安装后，如果有新版本可用， Connector 会自动进行更新。


.步骤
. 验证 Docker 是否已启用且正在运行。
+
[source, cli]
----
sudo systemctl enable docker && sudo systemctl start docker
----
. 如果在主机上设置了_http_proxy_或_https_proxy_系统变量、请将其删除：
+
[source, cli]
----
unset http_proxy
unset https_proxy
----
+
如果不删除这些系统变量、安装将失败。

. 从下载Connector软件 https://mysupport.netapp.com/site/products/all/details/cloud-manager/downloads-tab["NetApp 支持站点"^]，然后将其复制到 Linux 主机。
+
您应下载用于您的网络或云中的"联机"Connector安装程序。Connector可以使用单独的"脱机"安装程序、但只有专用模式部署才支持此安装程序。

. 分配运行脚本的权限。
+
[source, cli]
----
chmod +x OnCommandCloudManager-<version>
----
+
其中、<version> 是您下载的连接器版本。

. 运行安装脚本。
+
[source, cli]
----
 ./OnCommandCloudManager-<version> --proxy <HTTP or HTTPS proxy server> --cacert <path and file name of a CA-signed certificate>
----
+
-proxy和-cacert参数是可选的。如果您有代理服务器、则需要输入所示的参数。安装程序不会提示您提供有关代理的信息。

+
以下是使用这两个可选参数的命令示例：

+
[source, cli]
----
 ./OnCommandCloudManager-V3.9.26 --proxy https://user:password@10.0.0.30:8080/ --cacert /tmp/cacert/certificate.cer
----
+
-proxy会将Connector配置为使用以下格式之一的HTTP或HTTPS代理服务器：

+
** http://address:port
** http://username:password@address:port
** https://address:port
** https://username:password@address:port
+
用户必须是本地用户。不支持域用户。



+
-cacert指定用于在Connector和代理服务器之间进行HTTPS访问的CA签名证书。H



.结果
此时将安装Connector。在安装结束时、如果您指定了代理服务器、则Connector服务(occa)将重新启动两次。

.下一步是什么？
设置BlueXP。

--
====


== 设置BlueXP

首次访问BlueXP控制台时、系统将提示您选择要与Connector关联的帐户、您需要启用受限模式。


NOTE: 如果您已有帐户、但要创建另一个帐户、则需要使用租户API。 link:task-create-account.html["了解如何创建其他BlueXP帐户"]。

.步骤
. 从已连接到 Connector 实例的主机打开 Web 浏览器，然后输入以下 URL ：
+
https://_ipaddress_[]

. 注册或登录到BlueXP。
. 登录后、设置BlueXP：
+
.. 输入Connector的名称。
.. 输入新BlueXP帐户的名称或选择现有帐户。
+
如果您的登录已与BlueXP帐户关联、则可以选择一个现有帐户。

.. 选择*是否在安全环境中运行？*
.. 选择*对此帐户启用受限模式*。
+
请注意、在BlueXP创建帐户后、您无法更改此设置。您不能稍后启用受限模式、也不能稍后禁用它。

+
如果您在政府区域部署了Connector、则此复选框已启用、无法更改。这是因为受限模式是政府区域唯一支持的模式。

+
image:screenshot-restricted-mode.png["显示欢迎页面的屏幕截图、您需要在此页面中输入Connector名称和帐户名称、并可为此帐户启用受限模式。"]

.. 单击*我们开始*。




.结果
现在、您可以使用BlueXP帐户安装并设置Connector。所有用户都需要使用Connector实例的IP地址访问BlueXP。

.下一步是什么？
为BlueXP提供您先前设置的权限。



== 提供BlueXP的权限

如果您从Azure Marketplace部署了Connector、或者手动安装了Connector软件、则需要提供先前设置的权限、以便可以使用BlueXP服务。

如果您从AWS Marketplace部署了Connector、则这些步骤不适用、因为您在部署期间选择了所需的IAM角色。

link:task-prepare-restricted-mode.html#prepare-cloud-permissions["了解如何准备云权限"]。

[role="tabbed-block"]
====
.AWS IAM角色
--
将先前创建的IAM角色附加到安装了Connector的EC2实例。

只有在AWS中手动安装Connector时、这些步骤才适用。对于AWS Marketplace部署、您已将Connector实例与包含所需权限的IAM角色关联。

.步骤
. 转到Amazon EC2控制台。
. 选择*实例*。
. 选择Connector实例。
. 选择*操作>安全性>修改IAM角色*。
. 选择IAM角色、然后单击*更新IAM角色*。


.结果
现在、BlueXP拥有代表您在AWS中执行操作所需的权限。

--
.AWS访问密钥
--
为BlueXP提供具有所需权限的IAM用户的AWS访问密钥。

.步骤
. 确保当前在BlueXP中选择了正确的Connector。
. 在BlueXP控制台的右上角、单击设置图标、然后选择*凭据*。
+
image:screenshot_settings_icon.gif["一个屏幕截图、显示了BlueXP控制台右上角的设置图标。"]

. 单击 * 添加凭据 * ，然后按照向导中的步骤进行操作。
+
.. * 凭据位置 * ：选择 * Amazon Web Services > Connector* 。
.. *定义凭据*：输入AWS访问密钥和机密密钥。
.. * 市场订阅 * ：通过立即订阅或选择现有订阅，将市场订阅与这些凭据相关联。
.. * 查看 * ：确认有关新凭据的详细信息，然后单击 * 添加 * 。




.结果
现在、BlueXP拥有代表您在AWS中执行操作所需的权限。

--
.Azure角色
--
转到Azure门户、为一个或多个订阅向Connector虚拟机分配Azure自定义角色。

.步骤
. 从Azure门户中、打开*订阅*服务并选择您的订阅。
. 单击 * 访问控制（ IAM ） * > * 添加 * > * 添加角色分配 * 。
. 在*角色*选项卡中、选择* BlueXP操作员*角色、然后单击*下一步*。
+

NOTE: BlueXP操作员是BlueXP策略中提供的默认名称。如果您为角色选择了其他名称，请选择该名称。

. 在 * 成员 * 选项卡中，完成以下步骤：
+
.. 为 * 受管身份 * 分配访问权限。
.. 单击 * 选择成员 * ，选择创建 Connector 虚拟机的订阅，选择 * 虚拟机 * ，然后选择 Connector 虚拟机。
.. 单击 * 选择 * 。
.. 单击 * 下一步 * 。
.. 单击 * 审核 + 分配 * 。
.. 如果要从其他订阅部署 Cloud Volumes ONTAP 、请切换到该订阅，然后重复这些步骤。




.结果
现在、BlueXP拥有代表您在Azure中执行操作所需的权限。

--
.Azure服务主体
--
为BlueXP提供您先前设置的Azure服务主体的凭据。

.步骤
. 转至 https://console.bluexp.netapp.com["BlueXP控制台"^] 并登录。
. 在BlueXP控制台的右上角、单击设置图标、然后选择*凭据*。
+
image:screenshot_settings_icon.gif["一个屏幕截图、显示了BlueXP控制台右上角的设置图标。"]

. 单击 * 添加凭据 * ，然后按照向导中的步骤进行操作。
+
.. * 凭据位置 * ：选择 * Microsoft Azure > Connector* 。
.. * 定义凭据 * ：输入有关授予所需权限的 Azure Active Directory 服务主体的信息：
+
*** 应用程序(客户端) ID
*** 目录(租户) ID
*** 客户端密钥


.. * 市场订阅 * ：通过立即订阅或选择现有订阅，将市场订阅与这些凭据相关联。
.. * 查看 * ：确认有关新凭据的详细信息，然后单击 * 添加 * 。




.结果
现在、BlueXP拥有代表您在Azure中执行操作所需的权限。

--
.Google Cloud服务帐户
--
将服务帐户与Connector VM关联。

.步骤
. 转到Google Cloud门户、并将服务帐户分配给Connector VM实例。
+
https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#changeserviceaccountandscopes["Google Cloud文档：更改实例的服务帐户和访问范围"^]

. 如果要在其他项目中部署Cloud Volumes ONTAP 、请通过向该项目添加具有BlueXP角色的服务帐户来授予访问权限。您需要对每个项目重复此步骤。


.结果
现在、BlueXP拥有代表您在Google Cloud中执行操作所需的权限。

--
====
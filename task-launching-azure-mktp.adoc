---
sidebar: sidebar 
permalink: task-launching-azure-mktp.html 
keywords: install, installation, installing, marketplace, azure, deploy, virtual machine, permissions, deploy connector in azure, install connector in azure 
summary: 对于Azure商业区域、最好直接从BlueXP创建Connector、但如果愿意、您可以从Azure Marketplace启动Connector。对于Azure政府区域、您不能从BlueXP SaaS网站在政府区域部署Connector、因此、下一个最佳选择是从Azure Marketplace进行部署。 
---
= 从 Azure Marketplace 创建 Connector
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
对于Azure商业区域、最好直接从BlueXP创建Connector、但如果愿意、您可以从Azure Marketplace启动Connector。对于Azure政府区域、您不能从BlueXP SaaS网站在政府区域部署Connector、因此、下一个最佳选择是从Azure Marketplace进行部署。


TIP: 您还可以在网络或云中的现有Linux主机上下载并安装Connector软件。 link:task-installing-linux.html["了解如何在现有Linux主机上安装Connector"]。



== 在 Azure 中创建连接器

使用 Azure Marketplace 中的映像在 Azure 中部署 Connector ，然后登录到 Connector 以指定您的 NetApp 帐户。

.步骤
. 转到Azure Marketplace中的NetApp Connector VM页面。
+
** https://azuremarketplace.microsoft.com/en-us/marketplace/apps/netapp.netapp-oncommand-cloud-manager["适用于商业区域的Azure Marketplace页面"^]
** https://portal.azure.us/#create/netapp.netapp-oncommand-cloud-manageroccm-byol["Azure政府区域的Azure Marketplace页面"^]


. 单击 * 立即获取 * ，然后单击 * 继续 * 。
. 在 Azure 门户中，单击 * 创建 * ，然后按照步骤配置虚拟机。
+
配置虚拟机时，请注意以下事项：

+
** 此连接器可以对HDD或SSD磁盘执行最佳性能。
** 选择满足 CPU 和 RAM 要求的 VM 大小。我们建议使用 DS3 v2 。
+
link:task-installing-linux.html["查看虚拟机要求"]。

** 对于网络安全组， Connector 需要使用 SSH ， HTTP 和 HTTPS 进行入站连接。
+
link:reference-ports-azure.html["详细了解 Connector 的安全组规则"]。

** 在 * 管理 * 下，通过选择 * 启用 * 系统分配的托管身份 * 来为连接器启用。
+
此设置非常重要，因为托管身份允许 Connector 虚拟机在不提供任何凭据的情况下向 Azure Active Directory 标识自己。 https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview["详细了解 Azure 资源的托管身份"^]。



. 在 * 查看 + 创建 * 页面上，查看所做的选择并单击 * 创建 * 以开始部署。
+
Azure 使用指定的设置部署虚拟机。虚拟机和 Connector 软件应在大约五分钟内运行。

. 从已连接到 Connector 虚拟机的主机打开 Web 浏览器，然后输入以下 URL ：
+
https://_ipaddress_[]

. 登录后，设置 Connector ：
+
.. 指定要与 Connector 关联的 NetApp 帐户。
+
link:concept-netapp-accounts.html["了解 NetApp 客户"]。

.. 输入系统名称。




.结果
现在，您可以使用 NetApp 帐户安装并设置 Connector 。

如果Connector位于Azure商业区域、请打开Web浏览器并转到 https://console.bluexp.netapp.com[] 开始将Connector与BlueXP结合使用。

如果Connector位于Azure政府区域、则可以通过打开Web浏览器并连接到Connector实例的IP地址来使用BlueXP： https://_ipaddress_[]

由于Connector部署在政府区域、因此无法从访问 https://console.bluexp.netapp.com[]。



== 正在授予 Azure 权限

在 Azure 中部署 Connector 时，您应已启用 https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview["系统分配的受管身份"^]。现在，您必须先创建一个自定义角色，然后为一个或多个订阅的 Connector 虚拟机分配此角色，从而授予所需的 Azure 权限。

.步骤
. 创建自定义角色：
+
.. 复制的内容 link:reference-permissions-azure.html["Connector的自定义角色权限"] 并将其保存在JSON文件中。
.. 通过将 Azure 订阅 ID 添加到可分配范围来修改 JSON 文件。
+
您应该为每个 Azure 订阅添加 ID 、用户将从中创建 Cloud Volumes ONTAP 系统。

+
* 示例 *

+
[source, json]
----
"AssignableScopes": [
"/subscriptions/d333af45-0d07-4154-943d-c25fbzzzzzzz",
"/subscriptions/54b91999-b3e6-4599-908e-416e0zzzzzzz",
"/subscriptions/398e471c-3b42-4ae7-9b59-ce5bbzzzzzzz"
----
.. 使用 JSON 文件在 Azure 中创建自定义角色。
+
以下步骤介绍如何在 Azure Cloud Shell 中使用 Bash 创建角色。

+
*** start https://docs.microsoft.com/en-us/azure/cloud-shell/overview["Azure Cloud Shell"^] 并选择 Bash 环境。
*** 上传 JSON 文件。
+
image:screenshot_azure_shell_upload.png["Azure Cloud Shell 的屏幕截图，您可以在其中选择上传文件的选项。"]

*** 输入以下 Azure 命令行界面命令：
+
[source, azurecli]
----
az role definition create --role-definition Policy_for_Setup_As_Service_Azure.json
----
+
现在、您应该拥有一个名为BlueXP操作员的自定义角色、可以将该角色分配给Connector虚拟机。





. 为一个或多个订阅向 Connector 虚拟机分配角色：
+
.. 打开 * 订阅 * 服务，然后选择要部署 Cloud Volumes ONTAP 系统的订阅。
.. 单击 * 访问控制（ IAM ） * > * 添加 * > * 添加角色分配 * 。
.. 在*角色*选项卡中、选择* BlueXP操作员*角色、然后单击*下一步*。
+

NOTE: BlueXP操作员是BlueXP策略中提供的默认名称。如果您为角色选择了其他名称，请选择该名称。

.. 在 * 成员 * 选项卡中，完成以下步骤：
+
*** 为 * 受管身份 * 分配访问权限。
*** 单击 * 选择成员 * ，选择创建 Connector 虚拟机的订阅，选择 * 虚拟机 * ，然后选择 Connector 虚拟机。
*** 单击 * 选择 * 。
*** 单击 * 下一步 * 。


.. 单击 * 审核 + 分配 * 。
.. 如果要从其他订阅部署 Cloud Volumes ONTAP 、请切换到该订阅，然后重复这些步骤。




.结果
现在， Connector 拥有管理公有云环境中的资源和流程所需的权限。在创建新的工作环境时、BlueXP将自动使用此Connector。但是，如果您有多个 Connector ，则需要 link:task-managing-connectors.html["在它们之间切换"]。

如果您在创建Connector的同一Azure帐户中使用Azure Blob存储、则会在Canvas上自动显示Azure Blob工作环境。 link:task-viewing-azure-blob.html["详细了解如何使用此工作环境"]。



== 打开端口3128以显示AutoSupport 消息

如果您计划在出站Internet连接不可用的子网中部署Cloud Volumes ONTAP 系统、则BlueXP会自动将Cloud Volumes ONTAP 配置为使用此连接器作为代理服务器。

唯一的要求是确保Connector的安全组允许通过端口3128进行_inbound_连接。部署Connector后、您需要打开此端口。

如果对Cloud Volumes ONTAP 使用默认安全组、则不需要对其安全组进行任何更改。但是、如果您计划为Cloud Volumes ONTAP 定义严格的出站规则、则还需要确保Cloud Volumes ONTAP 安全组允许通过端口3128进行_outout_连接。
